name: Build
on: [pull_request, push]
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Install NDK
        run: echo "y" | sudo /usr/local/lib/android/sdk/tools/bin/sdkmanager --install "ndk;21.3.6528147" --sdk_root=${ANDROID_SDK_ROOT}
      - name: Checkout the code
        uses: actions/checkout@v2
      - name: Lint
        run: cd SmartCredentials_aOS && chmod +x ./gradlew lint
      - name: Test
        run: cd SmartCredentials_aOS && chmod +x ./gradlew test
      - name: Assemble all subproject aar files
        run: cd SmartCredentials_aOS && chmod +x ./gradlew assembleRelease && chmod +x ./gradlew publishToMavenLocal
        
      - name: Upload Authentication AAR
        uses: actions/upload-artifact@v2
        with:
            name: authentication
            path: SmartCredentials_aOS/authentication/build/outputs/aar/
      - name: Build Authentication Sample Application
        run: cd samples/authentication && chmod +x ./gradlew && ./gradlew build && ./gradlew assembleRelease              
      - name: Upload Authentication Sample APK
        uses: actions/upload-artifact@v2
        with:
            name: sampleApplications
            path: samples/authentication/app/build/outputs/apk/release/            
            
      - name: Upload Authorization AAR
        uses: actions/upload-artifact@v2
        with:
            name: authorization
            path: SmartCredentials_aOS/authorization/build/outputs/aar/
      - name: Build Authorization Sample Application
        run: cd samples/authorization && chmod +x ./gradlew && ./gradlew build && ./gradlew assembleRelease              
      - name: Upload Authorization Sample APK
        uses: actions/upload-artifact@v2
        with:
            name: sampleApplications
            path: samples/authorization/app/build/outputs/apk/release/ 
            
      - name: Upload Camera AAR
        uses: actions/upload-artifact@v2
        with:
            name: camera
            path: SmartCredentials_aOS/camera/build/outputs/aar/
      - name: Build Camera Sample Application
        run: cd samples/camera && chmod +x ./gradlew && ./gradlew build && ./gradlew assembleRelease              
      - name: Upload Camera Sample APK
        uses: actions/upload-artifact@v2
        with:
            name: sampleApplications
            path: samples/camera/app/build/outputs/apk/release/        
            
      - name: Upload Core AAR
        uses: actions/upload-artifact@v2
        with:
            name: core
            path: SmartCredentials_aOS/core/build/outputs/aar/
      - name: Build Core Sample Application
        run: cd samples/core && chmod +x ./gradlew && ./gradlew build && ./gradlew assembleRelease    
      - name: Upload Core Sample APK
        uses: actions/upload-artifact@v2
        with:
            name: sampleApplications
            path: samples/core/app/build/outputs/apk/release/    
            
      - name: Upload Document Scanner AAR
        uses: actions/upload-artifact@v2
        with:
            name: documentscanner
            path: SmartCredentials_aOS/documentscanner/build/outputs/aar/
      - name: Build Document Scanner Sample Application
        run: cd samples/documentscanner && chmod +x ./gradlew && ./gradlew build && ./gradlew assembleRelease    
      - name: Upload Document Scanner Sample APK
        uses: actions/upload-artifact@v2
        with:
            name: sampleApplications
            path: samples/documentscanner/app/build/outputs/apk/release/      
            
      - name: Upload eID AAR
        uses: actions/upload-artifact@v2
        with:
            name: eid
            path: SmartCredentials_aOS/eid/build/outputs/aar/
            
      - name: Upload Networking AAR
        uses: actions/upload-artifact@v2
        with:
            name: networking
            path: SmartCredentials_aOS/networking/build/outputs/aar/
            
      - name: Upload OTP AAR
        uses: actions/upload-artifact@v2
        with:
            name: otp
            path: SmartCredentials_aOS/otp/build/outputs/aar/
      - name: Build OTP Sample Application
        run: cd samples/otp && chmod +x ./gradlew && ./gradlew build && ./gradlew assembleRelease    
      - name: Upload OTP Sample APK
        uses: actions/upload-artifact@v2
        with:
            name: sampleApplications
            path: samples/otp/app/build/outputs/apk/release/     
           
      - name: Upload Persistent Logging AAR
        uses: actions/upload-artifact@v2
        with:
            name: persistentlogging
            path: SmartCredentials_aOS/persistentlogging/build/outputs/aar/
            
      - name: Upload Push Notifications AAR
        uses: actions/upload-artifact@v2
        with:
            name: pushnotifications
            path: SmartCredentials_aOS/pushnotifications/build/outputs/aar/
      - name: Build Push Notifications Sample Application
        run: cd samples/pushnotifications && chmod +x ./gradlew && ./gradlew build && ./gradlew assembleRelease    
      - name: Upload Push Notifications Sample APK
        uses: actions/upload-artifact@v2
        with:
            name: sampleApplications
            path: samples/pushnotifications/app/build/outputs/apk/release/        
            
      - name: Upload QR Login AAR
        uses: actions/upload-artifact@v2
        with:
            name: qrlogin
            path: SmartCredentials_aOS/qrlogin/build/outputs/aar/
            
      - name: Upload Security AAR
        uses: actions/upload-artifact@v2
        with:
            name: security
            path: SmartCredentials_aOS/security/build/outputs/aar/
            
      - name: Upload Storage AAR
        uses: actions/upload-artifact@v2
        with:
            name: storage
            path: SmartCredentials_aOS/storage/build/outputs/aar/
      - name: Build Storage Sample Application
        run: cd samples/storage && chmod +x ./gradlew && ./gradlew build && ./gradlew assembleRelease    
      - name: Upload Storage Sample APK
        uses: actions/upload-artifact@v2
        with:
            name: sampleApplications
            path: samples/storage/app/build/outputs/apk/release/       